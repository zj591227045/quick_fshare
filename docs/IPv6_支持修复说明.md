# IPv6 ç½‘ç»œæ”¯æŒä¿®å¤è¯´æ˜

## é—®é¢˜æ¦‚è¿°

ç”¨æˆ·æŠ¥å‘Šåœ¨ä½¿ç”¨IPv6ç½‘ç»œè®¿é—®Quick FShareæœåŠ¡æ—¶ï¼Œä¸‹è½½æ–‡ä»¶å¤±è´¥å¹¶è¿”å›500é”™è¯¯ã€‚ç»è¿‡åˆ†æï¼Œä¸»è¦é—®é¢˜å‡ºç°åœ¨ï¼š

1. **æœåŠ¡å™¨ç›‘å¬é…ç½®é—®é¢˜** - åç«¯æœåŠ¡å™¨é»˜è®¤åªç›‘å¬IPv4
2. **Nginxä»£ç†é…ç½®é—®é¢˜** - æ²¡æœ‰é…ç½®IPv6ç›‘å¬å’Œæ­£ç¡®çš„ä»£ç†å¤´éƒ¨
3. **å®¢æˆ·ç«¯IPè¯†åˆ«é—®é¢˜** - æ— æ³•æ­£ç¡®å¤„ç†IPv6åœ°å€æ ¼å¼
4. **åœ°å€éªŒè¯é—®é¢˜** - IPv6åœ°å€éªŒè¯æ­£åˆ™è¡¨è¾¾å¼ä¸å®Œæ•´

## ä¿®å¤å†…å®¹

### 1. åç«¯æœåŠ¡å™¨ä¿®å¤

**æ–‡ä»¶**: `backend/server.js`

- âœ… æ·»åŠ  `app.set('trust proxy', true)` æ”¯æŒä»£ç†ç¯å¢ƒä¸‹çš„IPè¯†åˆ«
- âœ… ä¿®æ”¹ç›‘å¬åœ°å€ä¸º `'::'` æ”¯æŒIPv4å’ŒIPv6åŒæ ˆç›‘å¬

```javascript
// è®¾ç½®ä»£ç†ä¿¡ä»»ï¼Œæ”¯æŒIPv6
app.set('trust proxy', true);

// å¯åŠ¨HTTPæœåŠ¡å™¨ï¼Œæ”¯æŒIPv4å’ŒIPv6
app.listen(PORT, '::', () => {
  console.log(`ğŸš€ Quick FShare Backend æœåŠ¡å™¨è¿è¡Œåœ¨ç«¯å£ ${PORT} (IPv4 + IPv6)`);
});
```

### 2. Nginx é…ç½®ä¿®å¤

**æ–‡ä»¶**: `docker/nginx.conf`

- âœ… æ·»åŠ  `listen [::]:80;` æ”¯æŒIPv6ç›‘å¬
- âœ… æ·»åŠ IPv6ç›¸å…³çš„ä»£ç†å¤´éƒ¨è®¾ç½®
- âœ… ä¼˜åŒ–å¤§æ–‡ä»¶ä¸‹è½½é…ç½®

```nginx
server {
    listen 80;
    listen [::]:80;  # æ·»åŠ IPv6ç›‘å¬
    
    location /api/ {
        # æ·»åŠ IPv6æ”¯æŒçš„å¤´éƒ¨
        proxy_set_header X-Client-IP $remote_addr;
        proxy_set_header X-Original-Forwarded-For $http_x_forwarded_for;
        
        # å¤§æ–‡ä»¶ä¸Šä¼ å’Œä¸‹è½½ä¼˜åŒ–
        proxy_buffering off;
        proxy_request_buffering off;
    }
}
```

### 3. å®¢æˆ·ç«¯IPå¤„ç†ä¼˜åŒ–

**æ–‡ä»¶**: `backend/src/controllers/browseController.js`

- âœ… æ–°å¢ `getClientIP()` æ–¹æ³•ï¼Œä»å¤šä¸ªæ¥æºè·å–çœŸå®IP
- âœ… æ–°å¢ `formatClientIP()` æ–¹æ³•ï¼Œæ­£ç¡®æ ¼å¼åŒ–IPv6åœ°å€
- âœ… å¤„ç†IPv6æ˜ å°„IPv4åœ°å€ (`::ffff:` å‰ç¼€)
- âœ… æ›´æ–°æ‰€æœ‰ä½¿ç”¨å®¢æˆ·ç«¯IPçš„åœ°æ–¹

```javascript
getClientIP(req) {
  let clientIp = req.ip 
    || req.headers['x-client-ip']
    || req.headers['x-real-ip'] 
    || req.headers['x-forwarded-for']?.split(',')[0]?.trim()
    || req.connection?.remoteAddress 
    || req.socket?.remoteAddress
    || 'unknown';

  // æ¸…ç†IPv6æ˜ å°„IPv4åœ°å€
  if (clientIp && clientIp.startsWith('::ffff:')) {
    clientIp = clientIp.substring(7);
  }

  return clientIp;
}
```

### 4. IPv6 åœ°å€éªŒè¯æ”¹è¿›

**æ–‡ä»¶**: `backend/src/utils/validator.js`

- âœ… æ”¹è¿›IPv6æ­£åˆ™è¡¨è¾¾å¼ï¼Œæ”¯æŒå„ç§ç¼©å†™å½¢å¼
- âœ… å¤„ç†IPv6æ˜ å°„IPv4åœ°å€
- âœ… æ”¯æŒå®Œæ•´å’Œå‹ç¼©çš„IPv6æ ¼å¼

### 5. é™æµä¸­é—´ä»¶ä¼˜åŒ–

**æ–‡ä»¶**: `backend/src/middleware/rateLimit.js`

- âœ… æ›´æ–°å®¢æˆ·ç«¯æ ‡è¯†ç¬¦è·å–é€»è¾‘
- âœ… ç»Ÿä¸€IPv6åœ°å€å¤„ç†æ–¹å¼

## æµ‹è¯•éªŒè¯

### è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬

åˆ›å»ºäº† `scripts/test-ipv6.js` æµ‹è¯•è„šæœ¬ï¼Œç”¨äºéªŒè¯IPv6è¿æ¥ï¼š

```bash
# è¿è¡ŒIPv6è¿æ¥æµ‹è¯•
cd scripts
node test-ipv6.js

# æˆ–æŒ‡å®šæµ‹è¯•URL
TEST_URL=http://your-server:3001 node test-ipv6.js
```

æµ‹è¯•å†…å®¹åŒ…æ‹¬ï¼š
- ç½‘ç»œåè®®ç‰ˆæœ¬æ£€æµ‹
- å¥åº·æ£€æŸ¥æ¥å£
- æ–‡ä»¶æµè§ˆAPI
- æ–‡ä»¶ä¸‹è½½API

### æ‰‹åŠ¨æµ‹è¯•æ–¹æ³•

1. **æ£€æŸ¥æœåŠ¡å™¨ç›‘å¬çŠ¶æ€**ï¼š
```bash
# æŸ¥çœ‹ç«¯å£ç›‘å¬æƒ…å†µ
netstat -tlnp | grep 3001
# åº”è¯¥çœ‹åˆ°æ—¢æœ‰ 0.0.0.0:3001 ä¹Ÿæœ‰ :::3001

# æˆ–ä½¿ç”¨ ss å‘½ä»¤
ss -tlnp | grep 3001
```

2. **æµ‹è¯•IPv6è¿æ¥**ï¼š
```bash
# ä½¿ç”¨curlæµ‹è¯•IPv6è¿æ¥
curl -6 http://[::1]:3001/api/health

# æµ‹è¯•ä¸‹è½½åŠŸèƒ½
curl -6 -I http://[::1]:3001/api/browse/1/download/test.txt
```

3. **æŸ¥çœ‹æ—¥å¿—**ï¼š
```bash
# æ£€æŸ¥åç«¯æ—¥å¿—ä¸­çš„IPv6åœ°å€è®°å½•
tail -f backend/logs/app.log | grep -E '\[.*:.*\]|IPv6'
```

## éƒ¨ç½²æ³¨æ„äº‹é¡¹

### Docker ç¯å¢ƒ

å¦‚æœä½¿ç”¨Dockeréƒ¨ç½²ï¼Œç¡®ä¿ï¼š

1. **Dockerç½‘ç»œé…ç½®**æ”¯æŒIPv6ï¼š
```yaml
# docker-compose.yml
networks:
  default:
    enable_ipv6: true
    ipam:
      config:
        - subnet: "2001:db8::/64"
```

2. **ç«¯å£æ˜ å°„**åŒ…å«IPv6ï¼š
```yaml
ports:
  - "80:80"
  - "[::]:80:80"  # IPv6ç«¯å£æ˜ å°„
```

### ç³»ç»Ÿçº§é…ç½®

ç¡®ä¿ç³»ç»Ÿæ”¯æŒIPv6ï¼š

1. **æ£€æŸ¥IPv6æ˜¯å¦å¯ç”¨**ï¼š
```bash
cat /proc/sys/net/ipv6/conf/all/disable_ipv6
# è¾“å‡ºåº”è¯¥æ˜¯ 0 (å¯ç”¨)
```

2. **æ£€æŸ¥é˜²ç«å¢™è®¾ç½®**ï¼š
```bash
# ç¡®ä¿IPv6ç«¯å£æ˜¯å¼€æ”¾çš„
ip6tables -L | grep 3001
```

## å¸¸è§é—®é¢˜æ’æŸ¥

### 1. è¿æ¥è¢«æ‹’ç»

**ç—‡çŠ¶**: å®¢æˆ·ç«¯æ— æ³•è¿æ¥åˆ°IPv6åœ°å€
**è§£å†³**: 
- æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦æ­£ç¡®ç›‘å¬IPv6ç«¯å£
- ç¡®è®¤é˜²ç«å¢™å…è®¸IPv6æµé‡
- éªŒè¯ç½‘ç»œé…ç½®

### 2. åœ°å€è§£æé”™è¯¯

**ç—‡çŠ¶**: æ—¥å¿—ä¸­æ˜¾ç¤ºæ— æ•ˆçš„IPv6åœ°å€æ ¼å¼
**è§£å†³**:
- æ£€æŸ¥ä»£ç†é…ç½®æ˜¯å¦æ­£ç¡®ä¼ é€’åœ°å€
- ç¡®è®¤trust proxyè®¾ç½®å·²å¯ç”¨

### 3. ä¸‹è½½ä»ç„¶å¤±è´¥

**ç—‡çŠ¶**: æ–‡ä»¶æµè§ˆæ­£å¸¸ä½†ä¸‹è½½å¤±è´¥
**è§£å†³**:
- æ£€æŸ¥æ–‡ä»¶è·¯å¾„ç¼–ç æ˜¯å¦æ­£ç¡®
- ç¡®è®¤æ–‡ä»¶æƒé™è®¾ç½®
- æŸ¥çœ‹è¯¦ç»†é”™è¯¯æ—¥å¿—

## éªŒè¯ä¿®å¤æ•ˆæœ

ä¿®å¤å®Œæˆåï¼Œåº”è¯¥èƒ½å¤Ÿï¼š

1. âœ… ä½¿ç”¨IPv6åœ°å€æ­£å¸¸è®¿é—®æœåŠ¡
2. âœ… é€šè¿‡IPv6ç½‘ç»œæµè§ˆæ–‡ä»¶åˆ—è¡¨  
3. âœ… é€šè¿‡IPv6ç½‘ç»œä¸‹è½½æ–‡ä»¶
4. âœ… åœ¨è®¿é—®æ—¥å¿—ä¸­çœ‹åˆ°æ­£ç¡®çš„IPv6åœ°å€è®°å½•
5. âœ… é™æµå’Œå®‰å…¨åŠŸèƒ½åœ¨IPv6ç¯å¢ƒä¸‹æ­£å¸¸å·¥ä½œ

## åç»­ä¼˜åŒ–å»ºè®®

1. **ç›‘æ§æ”¹è¿›**: æ·»åŠ IPv6ç‰¹å®šçš„ç›‘æ§æŒ‡æ ‡
2. **æ—¥å¿—å¢å¼º**: åŒºåˆ†IPv4å’ŒIPv6è®¿é—®ç»Ÿè®¡
3. **æ€§èƒ½ä¼˜åŒ–**: é’ˆå¯¹IPv6ç½‘ç»œçš„æ€§èƒ½è°ƒä¼˜
4. **å®‰å…¨åŠ å›º**: IPv6ç¯å¢ƒä¸‹çš„å®‰å…¨ç­–ç•¥ä¼˜åŒ–

---

**æ³¨æ„**: ä¿®å¤å®Œæˆåéœ€è¦é‡å¯æœåŠ¡ä»¥ä½¿é…ç½®ç”Ÿæ•ˆã€‚å»ºè®®åœ¨æµ‹è¯•ç¯å¢ƒå…ˆéªŒè¯ä¿®å¤æ•ˆæœåå†éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒã€‚ 