# Quick FShare å•ä¸€å®¹å™¨éƒ¨ç½²
# å°†å‰ç«¯ã€åç«¯ã€æ•°æ®åº“æ‰“åŒ…ä¸ºå•ä¸€å®¹å™¨

# ä½¿ç”¨åŒ…å«Node.jsçš„åŸºç¡€é•œåƒ
FROM node:18-alpine

# å®‰è£…å¿…è¦çš„ç³»ç»Ÿå·¥å…·
RUN apk add --no-cache \
    nginx \
    sqlite \
    curl \
    supervisor \
    dumb-init

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# ======== æ„å»ºå‰ç«¯ ========
COPY frontend/package*.json ./frontend/
RUN cd frontend && npm install --verbose

COPY frontend/ ./frontend/
RUN cd frontend && npm run build

# ======== å®‰è£…åç«¯ä¾èµ– ========
COPY backend/package*.json ./backend/
RUN cd backend && npm install --only=production --verbose

COPY backend/ ./backend/
RUN cd backend && npm run build && npm run verify

# ======== å¤åˆ¶æ•°æ®åº“ç›¸å…³æ–‡ä»¶ ========
COPY database/ ./database/

# ======== é…ç½®Nginx ========
# åˆ›å»ºNginxé…ç½®ç›®å½•å’Œè¿è¡Œç›®å½•
RUN mkdir -p /etc/nginx/conf.d /var/log/nginx /run/nginx /var/cache/nginx

# ä½¿ç”¨ç°æœ‰çš„nginx.confä½œä¸ºç«™ç‚¹é…ç½®
COPY docker/nginx.conf /etc/nginx/conf.d/default.conf

# åˆ›å»ºåŸºç¡€nginxé…ç½®
RUN echo 'user nginx;' > /etc/nginx/nginx.conf && \
    echo 'worker_processes auto;' >> /etc/nginx/nginx.conf && \
    echo 'error_log /var/log/nginx/error.log notice;' >> /etc/nginx/nginx.conf && \
    echo 'pid /var/run/nginx.pid;' >> /etc/nginx/nginx.conf && \
    echo 'events { worker_connections 1024; use epoll; multi_accept on; }' >> /etc/nginx/nginx.conf && \
    echo 'http {' >> /etc/nginx/nginx.conf && \
    echo '  include /etc/nginx/mime.types;' >> /etc/nginx/nginx.conf && \
    echo '  default_type application/octet-stream;' >> /etc/nginx/nginx.conf && \
    echo '  log_format main '"'"'$remote_addr - $remote_user [$time_local] "$request" $status $body_bytes_sent "$http_referer" "$http_user_agent" "$http_x_forwarded_for"'"'"';' >> /etc/nginx/nginx.conf && \
    echo '  access_log /var/log/nginx/access.log main;' >> /etc/nginx/nginx.conf && \
    echo '  sendfile on; tcp_nopush on; tcp_nodelay on; keepalive_timeout 65; types_hash_max_size 2048;' >> /etc/nginx/nginx.conf && \
    echo '  gzip on; gzip_vary on; gzip_min_length 1024; gzip_proxied any; gzip_comp_level 6;' >> /etc/nginx/nginx.conf && \
    echo '  gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss application/atom+xml image/svg+xml;' >> /etc/nginx/nginx.conf && \
    echo '  include /etc/nginx/conf.d/*.conf;' >> /etc/nginx/nginx.conf && \
    echo '}' >> /etc/nginx/nginx.conf

# åˆ›å»ºnginxç”¨æˆ·
RUN addgroup -g 101 -S nginx && adduser -S -D -H -u 101 -h /var/cache/nginx -s /sbin/nologin -G nginx -g nginx nginx

# ======== è®¾ç½®åº”ç”¨ç›®å½•ç»“æ„ ========
RUN mkdir -p \
    /app/logs \
    /app/database \
    /app/uploads \
    /app/thumbnails \
    /usr/share/nginx/html

# å¤åˆ¶æ„å»ºå¥½çš„å‰ç«¯æ–‡ä»¶åˆ°Nginxç›®å½•
RUN cp -r /app/frontend/dist/* /usr/share/nginx/html/

# ======== åˆ›å»ºSupervisoré…ç½® ========
RUN printf '[supervisord]\nnodaemon=true\nuser=root\nlogfile=/var/log/supervisord.log\npidfile=/var/run/supervisord.pid\n\n[program:backend]\ncommand=node server.js\ndirectory=/app/backend\nuser=nobody\nautostart=true\nautorestart=true\nstderr_logfile=/var/log/backend-error.log\nstdout_logfile=/var/log/backend.log\nenvironment=NODE_ENV=production,PORT=3001,DB_PATH=/app/database/fshare.db,UPLOAD_PATH=/app/uploads,THUMBNAIL_PATH=/app/thumbnails,LOG_LEVEL=info\n\n[program:nginx]\ncommand=nginx -g "daemon off;"\nuser=root\nautostart=true\nautorestart=true\nstderr_logfile=/var/log/nginx-error.log\nstdout_logfile=/var/log/nginx.log\n\n[supervisorctl]\nserverurl=unix:///tmp/supervisor.sock\n\n[unix_http_server]\nfile=/tmp/supervisor.sock\n' > /etc/supervisord.conf

# ======== åˆ›å»ºå¯åŠ¨è„šæœ¬ ========
RUN printf '#!/bin/sh\n\necho "ğŸš€ å¯åŠ¨ Quick FShare å•ä¸€å®¹å™¨..."\n\n# åˆå§‹åŒ–æ•°æ®åº“\necho "ğŸ“Š åˆå§‹åŒ–æ•°æ®åº“..."\ncd /app/backend && node scripts/init-db.js\n\n# è®¾ç½®æƒé™\necho "ğŸ” è®¾ç½®æ–‡ä»¶æƒé™..."\nchown -R nobody:nobody /app/logs /app/database /app/uploads /app/thumbnails\nchmod -R 755 /app/logs /app/database /app/uploads /app/thumbnails\n\necho "âœ… åˆå§‹åŒ–å®Œæˆï¼Œå¯åŠ¨æœåŠ¡..."\n\n# ä½¿ç”¨supervisorç®¡ç†å¤šä¸ªè¿›ç¨‹\nexec supervisord -c /etc/supervisord.conf\n' > /app/start.sh

# ======== è®¾ç½®ç¯å¢ƒå˜é‡ ========
ENV NODE_ENV=production \
    PORT=3001 \
    JWT_SECRET=your-super-secret-jwt-key-change-in-production \
    JWT_REFRESH_SECRET=your-super-secret-refresh-key-change-in-production \
    DB_PATH=/app/database/fshare.db \
    UPLOAD_PATH=/app/uploads \
    THUMBNAIL_PATH=/app/thumbnails \
    LOG_LEVEL=info \
    MAX_FILE_SIZE=104857600 \
    RATE_LIMIT_WINDOW=900000 \
    RATE_LIMIT_MAX=100

# ======== æš´éœ²ç«¯å£ ========
EXPOSE 80

# ======== å¥åº·æ£€æŸ¥ ========
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD curl -f http://localhost/health && curl -f http://localhost:3001/api/health || exit 1

# ======== æ•°æ®å· ========
VOLUME ["/app/database", "/app/uploads", "/app/thumbnails", "/app/logs"]

# ======== å¯åŠ¨å®¹å™¨ ========
RUN chmod +x /app/start.sh

# ä½¿ç”¨dumb-initå¤„ç†ä¿¡å·
ENTRYPOINT ["dumb-init", "--"]
CMD ["/app/start.sh"] 