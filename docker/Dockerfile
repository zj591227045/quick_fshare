# Quick FShare å•ä¸€å®¹å™¨éƒ¨ç½² - å¤šé˜¶æ®µæ„å»ºä¼˜åŒ–
# å°†å‰ç«¯ã€åç«¯ã€æ•°æ®åº“æ‰“åŒ…ä¸ºå•ä¸€å®¹å™¨

# ======== é˜¶æ®µ1: å‰ç«¯æ„å»º ========
FROM node:18-alpine AS frontend-builder

WORKDIR /app/frontend
COPY frontend/package*.json ./
RUN npm install

COPY frontend/ ./
RUN npm run build

# ======== é˜¶æ®µ2: åç«¯ä¾èµ–å®‰è£… ========
FROM node:18-alpine AS backend-builder

WORKDIR /app/backend
COPY backend/package*.json ./
RUN npm install --only=production && npm cache clean --force

# ======== é˜¶æ®µ3: æœ€ç»ˆè¿è¡Œé•œåƒ ========
FROM node:18-alpine

# å®‰è£…å¿…è¦çš„ç³»ç»Ÿå·¥å…·
RUN apk add --no-cache \
    nginx \
    sqlite \
    curl \
    supervisor \
    dumb-init && \
    rm -rf /var/cache/apk/*

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# ======== å¤åˆ¶åç«¯ä»£ç å’Œä¾èµ– ========
COPY backend/ ./backend/
COPY --from=backend-builder /app/backend/node_modules ./backend/node_modules

# ======== å¤åˆ¶å‰ç«¯æ„å»ºç»“æœ ========
COPY --from=frontend-builder /app/frontend/dist ./frontend/dist

# ======== å¤åˆ¶æ•°æ®åº“ç›¸å…³æ–‡ä»¶ ========
COPY database/ ./database/

# ======== é…ç½®Nginx ========
# åˆ›å»ºNginxé…ç½®ç›®å½•å’Œè¿è¡Œç›®å½•
RUN mkdir -p /etc/nginx/conf.d /var/log/nginx /run/nginx /var/cache/nginx

# ä½¿ç”¨ç°æœ‰çš„nginx.confä½œä¸ºç«™ç‚¹é…ç½®
COPY docker/nginx.conf /etc/nginx/conf.d/default.conf

# åˆ›å»ºåŸºç¡€nginxé…ç½®
RUN echo 'user nginx;' > /etc/nginx/nginx.conf && \
    echo 'worker_processes auto;' >> /etc/nginx/nginx.conf && \
    echo 'error_log /var/log/nginx/error.log notice;' >> /etc/nginx/nginx.conf && \
    echo 'pid /var/run/nginx.pid;' >> /etc/nginx/nginx.conf && \
    echo 'events { worker_connections 1024; use epoll; multi_accept on; }' >> /etc/nginx/nginx.conf && \
    echo 'http {' >> /etc/nginx/nginx.conf && \
    echo '  include /etc/nginx/mime.types;' >> /etc/nginx/nginx.conf && \
    echo '  default_type application/octet-stream;' >> /etc/nginx/nginx.conf && \
    echo '  log_format main '"'"'$remote_addr - $remote_user [$time_local] "$request" $status $body_bytes_sent "$http_referer" "$http_user_agent" "$http_x_forwarded_for"'"'"';' >> /etc/nginx/nginx.conf && \
    echo '  access_log /var/log/nginx/access.log main;' >> /etc/nginx/nginx.conf && \
    echo '  sendfile on; tcp_nopush on; tcp_nodelay on; keepalive_timeout 65; types_hash_max_size 2048;' >> /etc/nginx/nginx.conf && \
    echo '  gzip on; gzip_vary on; gzip_min_length 1024; gzip_proxied any; gzip_comp_level 6;' >> /etc/nginx/nginx.conf && \
    echo '  gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss application/atom+xml image/svg+xml;' >> /etc/nginx/nginx.conf && \
    echo '  include /etc/nginx/conf.d/*.conf;' >> /etc/nginx/nginx.conf && \
    echo '}' >> /etc/nginx/nginx.conf

# nginxç”¨æˆ·å·²ç”±nginxåŒ…è‡ªåŠ¨åˆ›å»º

# ======== ä¸€æ¬¡æ€§è®¾ç½®æ‰€æœ‰é…ç½®å’Œç›®å½• ========
RUN mkdir -p \
    /app/logs \
    /app/data/logs \
    /app/data/uploads \
    /app/data/thumbnails \
    /app/data/search-indexes \
    /app/database \
    /app/uploads \
    /app/thumbnails \
    /usr/share/nginx/html && \
    # å¤åˆ¶å‰ç«¯æ–‡ä»¶åˆ°nginxç›®å½•å¹¶æ¸…ç†æºæ–‡ä»¶
    cp -r /app/frontend/dist/* /usr/share/nginx/html/ && \
    rm -rf /app/frontend && \
    # è®¾ç½®ç›®å½•æƒé™ - ç¡®ä¿nobodyç”¨æˆ·æœ‰å†™æƒé™
    chown -R nobody:nobody /app/logs /app/data /app/database /app/uploads /app/thumbnails && \
    chmod -R 755 /app/logs /app/data /app/database /app/uploads /app/thumbnails && \
    # åˆ›å»ºSupervisoré…ç½®
    printf '[supervisord]\nnodaemon=true\nuser=root\nlogfile=/dev/stdout\nlogfile_maxbytes=0\npidfile=/var/run/supervisord.pid\n\n[program:backend]\ncommand=/bin/sh -c "cd /app/backend && exec node server.js"\ndirectory=/app\nuser=nobody\nautostart=true\nautorestart=true\nstdout_logfile=/dev/stdout\nstdout_logfile_maxbytes=0\nstderr_logfile=/dev/stderr\nstderr_logfile_maxbytes=0\nstdout_events_enabled=true\nstderr_events_enabled=true\nenvironment=NODE_ENV=production,NODE_OPTIONS=--openssl-legacy-provider,PORT=3001,DB_PATH=/app/database/fshare.db,UPLOAD_PATH=/app/uploads,THUMBNAIL_PATH=/app/thumbnails,LOG_LEVEL=info\nstopwaitsecs=10\nkillasgroup=true\nstopasgroup=true\n\n[program:nginx]\ncommand=nginx -g "daemon off;"\nuser=root\nautostart=true\nautorestart=true\nstdout_logfile=/dev/stdout\nstdout_logfile_maxbytes=0\nstderr_logfile=/dev/stderr\nstderr_logfile_maxbytes=0\nstopwaitsecs=10\n\n[supervisorctl]\nserverurl=unix:///tmp/supervisor.sock\n\n[unix_http_server]\nfile=/tmp/supervisor.sock\n' > /etc/supervisord.conf && \
    # åˆ›å»ºå¯åŠ¨è„šæœ¬
    printf '#!/bin/sh\n\necho "ğŸš€ å¯åŠ¨ Quick FShare å•ä¸€å®¹å™¨..."\n\n# ç¡®ä¿æ‰€æœ‰ç›®å½•å­˜åœ¨å¹¶è®¾ç½®æƒé™\necho "ğŸ“ ç¡®ä¿ç›®å½•ç»“æ„..."\nmkdir -p /app/logs /app/data/logs /app/data/uploads /app/data/thumbnails /app/data/search-indexes /app/database /app/uploads /app/thumbnails\n\n# è®¾ç½®æ­£ç¡®çš„æƒé™ï¼Œç¡®ä¿nobodyç”¨æˆ·èƒ½å¤Ÿå†™å…¥\nchown -R nobody:nobody /app/logs /app/data /app/database /app/uploads /app/thumbnails\nchmod -R 755 /app/logs /app/data /app/database /app/uploads /app/thumbnails\n\n# ç‰¹åˆ«ç¡®ä¿æ—¥å¿—ç›®å½•æƒé™\nchmod 755 /app/data/logs\nchown nobody:nobody /app/data/logs\n\n# æ£€æŸ¥æƒé™æ˜¯å¦è®¾ç½®æˆåŠŸ\necho "ğŸ“‹ æ£€æŸ¥æƒé™è®¾ç½®:"\nls -la /app/data/\nls -la /app/data/logs/\n\n# æ£€æŸ¥å…³é”®æ–‡ä»¶æ˜¯å¦å­˜åœ¨\nif [ ! -f "/app/backend/server.js" ]; then\n  echo "âŒ é”™è¯¯: backend/server.js ä¸å­˜åœ¨"\n  exit 1\nfi\n\nif [ ! -f "/app/backend/package.json" ]; then\n  echo "âŒ é”™è¯¯: backend/package.json ä¸å­˜åœ¨"\n  exit 1\nfi\n\n# åˆå§‹åŒ–æ•°æ®åº“\necho "ğŸ“Š åˆå§‹åŒ–æ•°æ®åº“..."\ncd /app/backend && node scripts/init-db.js\n\necho "âœ… åˆå§‹åŒ–å®Œæˆï¼Œå¯åŠ¨æœåŠ¡..."\necho "ğŸ“‹ æ—¥å¿—è¯´æ˜:"\necho "   - [SUPERVISOR] Supervisor ç®¡ç†æ—¥å¿—"\necho "   - [BACKEND] åç«¯æœåŠ¡æ—¥å¿—"\necho "   - [NGINX] Nginx æœåŠ¡æ—¥å¿—"\necho "========================================="\n\n# ä½¿ç”¨supervisorç®¡ç†å¤šä¸ªè¿›ç¨‹\nexec supervisord -c /etc/supervisord.conf\n' > /app/start.sh && \
    chmod +x /app/start.sh

# ======== è®¾ç½®ç¯å¢ƒå˜é‡ ========
ENV NODE_ENV=production \
    PORT=3001 \
    NODE_OPTIONS=--openssl-legacy-provider \
    JWT_SECRET=your-super-secret-jwt-key-change-in-production \
    JWT_REFRESH_SECRET=your-super-secret-refresh-key-change-in-production \
    DB_PATH=/app/database/fshare.db \
    UPLOAD_PATH=/app/uploads \
    THUMBNAIL_PATH=/app/thumbnails \
    LOG_LEVEL=info \
    MAX_FILE_SIZE=104857600 \
    RATE_LIMIT_WINDOW=900000 \
    RATE_LIMIT_MAX=100

# ======== æš´éœ²ç«¯å£ ========
EXPOSE 80

# ======== å¥åº·æ£€æŸ¥ ========
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD curl -f http://localhost/health && curl -f http://localhost:3001/api/health || exit 1

# ======== æ•°æ®å· ========
VOLUME ["/app/database", "/app/uploads", "/app/thumbnails", "/app/logs", "/app/data"]

# ä½¿ç”¨dumb-initå¤„ç†ä¿¡å·
ENTRYPOINT ["dumb-init", "--"]
CMD ["/app/start.sh"] 